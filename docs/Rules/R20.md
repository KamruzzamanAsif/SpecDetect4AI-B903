# Smell: Chain indexing on pandas DataFrames

## Motivation  

Patterns like

```python
df[mask]["col"] = 0               # two back-to-back [...]
df["col"].str.lower()[idx]        # attribute, then [...]
df[mask1][mask2].mean()           # cascade of filters
```

create an intermediate view vs. copy ambiguity in pandas.
Consequences:
`SettingWithCopyWarning` — but the assignment may still run silently in some branches, producing brittle bugs.
Extra allocation / slowdown — each [] slice materialises a new object.

Harder for pandas to optimise or parallelise.
Best practice is to combine the selectors into a single `.loc[]` (or `.iloc[]`) call or assign to a temporary variable:

```python
#  safe & explicit
df.loc[mask, "col"] = 0

# or
sub = df.loc[mask1 & mask2]
result = sub.mean()
```


---

## Detection strategy (high‑level view)

1. **AST parsing**  
   Look for every `Subscript` node ([...])

2. **Walk back up the AST chain**  
     if its `.value` is itself another `Subscript`, flag.

3. **Exclude cases that are conceptually fine:**
    - `.values[...], .to_numpy()[...]` – already a NumPy array
    - `.str[...], .dt[...], .apply[...], .map[...]`, etc.

4. **DataFrame**
    Confirm that the base object is recognised as a DataFrame/Series via the predicate`isDataFrameVariable`.

5. **Reporting**  

   When such a node is found the detector emits 
   REPORT: Avoid chained indexing in DataFrames at line `n `; use df.loc[] 



---

## Practical meaning for the developer 


### Chain Indexing
```python
df[df.x > 0]["y"].mean()
```

### Refactor
```python
df.loc[df.x > 0, "y"].mean()
```

### Chain Indexing
```python
df["text"].str.strip()[i]
```

### Refactor
```python
df.loc[i, "text"] = df.at[i, "text"].strip()
```


### Chain Indexing
```python
df[a][b] = val
```

### Refactor
```python
df.loc[a & b] = val
```


---

## Limitations  

- Rule skips chains that end in method calls not tied to assignment (e.g. `df[mask]["col"].plot()`) – stylistically arguable but less dangerous.
- Mixed loc/iloc chains (`df.loc[...].iloc[...]`) still raise the warning; merge them when possible.

